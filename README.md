
# ChatReportBot

**ChatReportBot** — Telegram-бот, который принимает стандартный **JSON-файл экспорта чата Telegram**, извлекает:
- участников (по истории сообщений),
- упоминания (например, `@username`),
- каналы/ссылки (например, `t.me/...`),

и возвращает результат:
- **в текстовом виде**, если участников **≤ 50**,
- **Excel (.xlsx)** с 3 вкладками, если участников **≥ 51**.

> Бот работает в режиме **long polling** и не требует публичного сервера.  
> Данные обрабатываются “на лету”: временные файлы удаляются после обработки, сессии очищаются.

---

## Документация

- **Архитектура**: `docs/architecture.md`
- **Инструкция пользователя**: `docs/user-guide.md`

---

## Стек проекта

- Java 21
- Maven
- TelegramBots (LongPolling)
- Jackson
- Apache POI (XLSX)
- SLF4J
- JUnit 5
- Lombok
- Docker + Docker Compose

---

## Функциональность

- Приём **1–10** файлов экспорта за одну сессию
- Поддержка **только JSON** (MVP)
- Сценарий работы: **копим файлы → жмём кнопку → обрабатываем**
- Результат по каждому файлу:
  - `≤ 50` участников → текстовое сообщение в Telegram
  - `≥ 51` участников → Excel-файл
- Excel содержит 3 вкладки:
  - **Участники**
  - **Упоминания**
  - **Каналы**
- Команды:
  - `/start` — начать новую сессию
  - `/stop` — сбросить текущую сессию
- Сессия имеет TTL и очищается при следующем действии пользователя после истечения (ленивый TTL)

---

## Запуск проекта

### Предварительные условия

Для запуска проекта необходимо иметь:
- установленный Docker и Docker Compose
- Java 21+
- Maven

---

### Запуск через Docker Compose (рекомендуется для сдачи)

1) Запустите Docker.

2) Получите токен у `@BotFather`.

3) Создайте в корне репозитория файл `.env`:

```env
BOT_TOKEN=REAL_TOKEN
BOT_NAME=your_bot_username
```

4. Запустите проект (из корня репозитория):

```bash
docker compose up --build
```

5. Посмотреть логи:

```bash
docker compose logs -f bot
```
---

### Локальный запуск (Maven)

**PowerShell (Windows):**

```powershell
$env:BOT_TOKEN="REAL_TOKEN"
$env:BOT_NAME="your_bot_username"
mvn -U clean test
mvn spring-boot:run
```

---

## Как пользоваться ботом (кратко)

1. Откройте диалог с ботом и отправьте `/start`
2. Загрузите 1–10 JSON-файлов экспорта
3. Нажмите **«Начать обработку»**
4. Получите результат по каждому файлу:

   * если участников `≤ 50` → текстовое сообщение
   * если участников `≥ 51` → Excel-файл

---

## Соответствие функциональным требованиям

1. **Приём истории чата**
   Бот поддерживает загрузку файлов экспорта чата в формате **JSON**.

2. **Извлечение участников**
   Система находит пользователей, писавших сообщения, и пользователей, упомянутых в тексте.

3. **Фильтрация и дедупликация**
   Реализовано удаление дублей и исключение “удалённых аккаунтов” (по признакам экспорта).

4. **Гибкий формат вывода**

   * при `≤ 50` участников → текстовый ответ
   * при `≥ 51` участников → Excel-файл

5. **Структура Excel**
   Файл содержит 3 вкладки: **Участники**, **Упоминания**, **Каналы**.

6. **Конфиденциальность**
   Данные обрабатываются “на лету”: временные файлы удаляются после завершения, сессии очищаются.

7. **Надёжность**
   Проект покрыт unit-тестами: парсинг, дедупликация, генерация Excel/текста.

8. **Контейнеризация**
   Проект настроен для запуска через Docker Compose.

---

## Тесты

Запуск всех тестов:

```bash
mvn test
```

---

## Конфигурация

Переменные окружения:

* `BOT_TOKEN` — токен бота (BotFather)
* `BOT_NAME` — username бота

---

## Структура проекта

```
src/main/java/com/example
  Bot.java
  core/        # парсинг, обработка, дедуп
  export/      # Excel/текстовый вывод
  session/     # сессии, TTL, хранение в памяти
  ui/          # тексты и клавиатуры
  enums/       # состояния и константы
docs/
  architecture.md
  user-guide.md
```

---
